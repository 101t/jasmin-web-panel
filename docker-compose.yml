version: '3.8'

services:
  jasmin-web:
    image: tarekaec/jasmin_web_panel:1.4.2
    ports:
      - "${JASMIN_WEB_PORT:-8999}:8000"
    deploy:
      replicas: 1
    env_file:
      - .env
    environment:
      DEBUG: 0
      DJANGO_SETTINGS_MODULE: config.settings.pro
      ALLOWED_HOSTS: '*'
      REDIS_URI: redis://redis:6379/1
      TELNET_HOST: jasmin
      SUBMIT_LOG: 1
    volumes:
      - web_public:/app/public
      - web_logs:/app/logs
    depends_on:
      - redis
      - db
      - rabbitmq
    restart: unless-stopped

  jasmin-celery:
    image: tarekaec/jasmin_web_panel:1.4.2
    entrypoint: bash ./docker-entrypoint-celery.sh
    deploy:
      replicas: 1
    env_file:
      - .env
    environment:
      DEBUG: 0
      DJANGO_SETTINGS_MODULE: config.settings.pro
      CELERY_LOG_LEVEL: info
    healthcheck:
      disable: true
    depends_on:
      - redis
      - db
    restart: unless-stopped

  redis:
    image: redis:alpine
    tty: true
    volumes:
      - redis_data:/data
    command:
      - 'redis-server'
      - '--appendonly yes'
      - '--save 10 1'
      - '--auto-aof-rewrite-percentage 100'
      - '--auto-aof-rewrite-min-size 64mb'
    restart: unless-stopped
    environment:
      REDIS_REPLICATION_MODE: master
      ALLOW_EMPTY_PASSWORD: "yes"
    healthcheck:
      test: redis-cli ping | grep PONG
    deploy:
      resources:
        limits:
          cpus: "${REDIS_CPU:-2}"
          memory: ${REDIS_MEM:-512M}
    security_opt:
      - no-new-privileges:true

  rabbitmq:
    image: rabbitmq:3.10-management-alpine
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      #RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-ssl_opts.server_name_indication disable"
    volumes:
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
    deploy:
      resources:
        limits:
          cpus: "${RABBITMQ_CPU:-4}"
          memory: ${RABBITMQ_MEM:-1024M}
        reservations:
          memory: 512M
    security_opt:
      - no-new-privileges:true

  db:
    image: postgres:18.0-alpine
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      POSTGRES_DB: "${POSTGRES_DB:-jasmin}"
      POSTGRES_USER: "${POSTGRES_USER:-jasmin}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-jasmin}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-jasmin}"]
      interval: 10s
      timeout: 5s
      retries: 5

  jasmin:
    image: jookies/jasmin:latest
    restart: unless-stopped
    volumes:
      - ./jasmin_config/resource:/etc/jasmin/resource
      - ./jasmin_config/store:/etc/jasmin/store
      - ./jasmin_config:/etc/jasmin
      - ./logs:/var/log/jasmin
    ports:
      - "${JASMIN_SMS_PORT:-2775}:2775"
      - "${JASMIN_DASHBOARD_PORT:-8990}:8990"
      - "${JASMIN_HTTP_API_PORT:-1401}:1401"
    depends_on:
      - redis
      - rabbitmq
    environment:
      REDIS_CLIENT_HOST: redis
      AMQP_BROKER_HOST: rabbitmq
      AMQP_BROKER_PORT: 5672
    sysctls:
      - net.ipv4.tcp_keepalive_time=60
      - net.ipv4.tcp_keepalive_intvl=10
      - net.ipv4.tcp_keepalive_probes=5
    deploy:
      resources:
        limits:
          cpus: "${JASMIN_CPU:-2}"
          memory: ${JASMIN_MEM:-512M}
    security_opt:
      - no-new-privileges:true

  sms_logger:
    image: jookies/jasmin:latest
    volumes:
      - ./jasmin_config/resource:/etc/jasmin/resource
      - ./jasmin_config:/etc/jasmin
      - ./sms_logger.py:/build/misc/scripts/sms_logger.py:ro
    command: bash -c "sleep 15 && pip install -U pip psycopg2-binary mysql-connector-python && exec python /build/misc/scripts/sms_logger.py"
    environment:
      DB_TYPE_MYSQL: ${DB_TYPE_MYSQL:-0}
      AMQP_BROKER_HOST: ${AMQP_BROKER_HOST:-rabbitmq}
      AMQP_BROKER_PORT: ${AMQP_BROKER_PORT:-5672}
      AMQP_SPEC_FILE: '/etc/jasmin/resource/amqp0-9-1.xml'
      AMQP_HEARTBEAT: 60  # Enable 60-second heartbeats
      RECONNECT_DELAY: 5  # Initial reconnect delay
      MAX_RECONNECT_DELAY: 60  # Max reconnect delay
      DB_HOST: ${DB_HOST:-db}
      DB_DATABASE: ${DB_DATABASE:-jasmin}
      DB_TABLE: ${DB_TABLE:-submit_log}
      DB_USER: ${DB_USER:-jasmin}
      DB_PASS: ${DB_PASS:-jasmin}
    depends_on:
      - rabbitmq
      - db
      - jasmin
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "sms_logger.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    sysctls:
      net.ipv4.tcp_keepalive_time: 60
      net.ipv4.tcp_keepalive_intvl: 10
      net.ipv4.tcp_keepalive_probes: 5

volumes:
  web_public:
    driver: local
  web_logs:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  postgres_data:
    driver: local
  monitoring_data:
    driver: local
